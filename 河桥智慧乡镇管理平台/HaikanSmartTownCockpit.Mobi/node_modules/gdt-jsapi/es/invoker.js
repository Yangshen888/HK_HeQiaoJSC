import _regeneratorRuntime from"@babel/runtime/regenerator";import _extends from"@babel/runtime/helpers/extends";import _asyncToGenerator from"@babel/runtime/helpers/asyncToGenerator";import{isUndef}from"./utils/common";export var BRIDGE_ERROR_CODE;!function(e){e.CANCEL="-1",e.SUCCESS="0",e.API_UNDEFINED="1",e.INVALID_PARAMS="2",e.UNKNOWN_ERROR="3",e.UNAUTHORIZED_CALL="4",e.WRONG_CORP_ID="5",e.CREATE_CHAT_FAILED="6",e.UNAUTHORIZED_API="7",e.INVALID_CORP_ID="8",e.SERVER_RESPONSE_ERROR="9",e.WRONG_DEVICE_INFO="10",e.UPLOAD_FAIL="11",e.PROCESS_FAIL="12",e.DUPLICATED_CALL="13",e.TOO_LARGE_PIC="14",e.REQUEST_REJECT_OR_INSECURE_REQUEST="15",e.PC_NOT_ALLOWED_TO_OPEN_SIDE_PANE_OR_MODAL="21",e.PC_CLOSE_SIDE_PANE_OR_MODAL="22",e.UNAUTHORIZED_PARAMS="23",e.GESTURE_PASSWORD_DOES_NOT_EXIST="24",e.NETWORK_ERROR="25"}(BRIDGE_ERROR_CODE||(BRIDGE_ERROR_CODE={}));export var API_INVOKER_TYPE;!function(e){e.MOBILE="mobile",e.PC="pc",e.MINI_APP="mini",e.UNKNOWN="unknown"}(API_INVOKER_TYPE||(API_INVOKER_TYPE={}));export var CONTINUOUS_EVENT_LIST;!function(e){e.UPDATE_NETWORK_STATUS="DINGGOV_ON_NETWORK_TYPE_CHANGED",e.UPDATE_LOCATION="DINGGOV_GEO_LOCATION_UPDATE",e.UPDATE_TRACE="DINGGOV_TRACE_UPDATE",e.ON_SHAKE="onShake"}(CONTINUOUS_EVENT_LIST||(CONTINUOUS_EVENT_LIST={}));var Invoker=function(){function e(){this.currentInvoker=void 0,this.readyFnStack=[],this.generalEventCallbackStack={},this.apiList={},this.continuousCallbackStack={},this.isH5Mobile=null,this.appType=null,this.aliBridge=window&&window.navigator&&window.AlipayJSBridge,this.isReady=!1,this.init()}var n=e.prototype;return n.init=function(){var e=this,n=this.getAppType();n===API_INVOKER_TYPE.PC&&window.dingtalk&&!window.dingtalk.isRegister&&(window.dingtalk.isRegister=!0,window.dingtalk.callbackStack={},window.dingtalk.event.register((function(n,t){if(e.continuousCallbackStack[n])e.continuousCallbackStack[n](t);else{var i=""+t.msgId;"openapi.event.emit"===n?(console.log("dingtalk receive event:",t,"identifer is",i),window.dingtalk.callbackStack[i]&&(window.dingtalk.callbackStack[i](t),delete window.dingtalk.callbackStack[i])):"im.fileTask.addNewTask"===n||"im.fileTask.updateTask"===n?e.continuousCallbackStack[t.msgId||t.taskId](n,t):e.generalEventCallbackStack[n]&&e.generalEventCallbackStack[n].forEach((function(n){n.call(e,t)}))}}))),n===API_INVOKER_TYPE.MOBILE?window.AlipayJSBridge?this.execReadyFn():document.addEventListener("AlipayJSBridgeReady",(function(){e.execReadyFn.call(e)}),!1):setTimeout((function(){e.execReadyFn()}))},n.execReadyFn=function(){this.isReady=!0;for(var e=this.readyFnStack.shift();e;)e&&e(this),e=this.readyFnStack.shift()},n.onReady=function(e){this.isReady?e&&e(this):this.readyFnStack.push(e)},n.setCurrentInvoker=function(e){this.currentInvoker=e},n.getCurrentInvoker=function(){return this.currentInvoker},n.getBridge=function(){return this.aliBridge},n.getAppType=function(){return this.appType||(this.isMobile()?this.appType=API_INVOKER_TYPE.MOBILE:window&&window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.indexOf("dingtalk-win")>=0?this.appType=API_INVOKER_TYPE.PC:isUndef(typeof my)||null===my||isUndef(typeof my.alert)?(console.warn("检测到页面在非政务钉钉客户端中打开，JSAPI 调用可能不会生效！"),this.appType=API_INVOKER_TYPE.UNKNOWN):this.appType=API_INVOKER_TYPE.MINI_APP),this.appType},n.isMobile=function(){if(null!==this.isH5Mobile)return this.isH5Mobile;var e=window&&window.navigator&&window.navigator.userAgent||"";return e&&e.indexOf("dingtalk-win")>=0?(this.isH5Mobile=!1,!1):!!(e&&e.indexOf("mPaaSClient")>=0)&&(this.isH5Mobile=!0,!0)},n.registerEvent=function(e,n){var t=this;if("function"==typeof n)return this.getAppType()===API_INVOKER_TYPE.PC?(this.generalEventCallbackStack[e]||(this.generalEventCallbackStack[e]=[]),this.generalEventCallbackStack[e].push(n),function(){var i=t.generalEventCallbackStack[e].findIndex((function(e){return e===n}));t.generalEventCallbackStack[e].splice(i,1)}):this.getAppType()===API_INVOKER_TYPE.MOBILE?(document.addEventListener(e,n,!1),function(){document.removeEventListener(e,n)}):void 0;console.error("callback 参数应该为函数")},n.registerClientAPI=function(e,n){this.apiList[e]=n},n.registerAPI=function(e,n){this.isMobile();if("object"==typeof n){var t=n,i=this.getAppType();this.registerClientAPI(e,t[i])}else this.registerClientAPI(e,n)},n.invokeMiniApp=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n,t){var i=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t={}),e.abrupt("return",new Promise((function(e,r){t=_extends({_apiName:n},t);var a=i.apiList[n];if(!a)return console.warn("API: "+n+"，未注册"),r("API: "+n+"，未注册");"function"!=typeof a?my.call(n,t,(function(n){i.handleBridgeResponse(n,e,r)})):a.call(null,t,{context:my,resolve:e,reject:r,methodName:n})})));case 2:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),n.invokeMobile=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n,t){var i=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t={}),e.abrupt("return",new Promise((function(e,r){t=_extends({_apiName:n},t);var a=i.apiList[n];if(!a)return console.warn("API: "+n+"，未注册"),r("API: "+n+"，未注册");"function"!=typeof a?AlipayJSBridge.call(n,t,(function(n){i.handleBridgeResponse(n,e,r)})):a.call(null,t,{context:AlipayJSBridge,resolve:e,reject:r,methodName:n})})));case 2:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),n.findFitMsgId=function(e){var n,t;return(null===(n=window.dingtalk)||void 0===n||null===(t=n.callbackStack)||void 0===t?void 0:t[e])?this.findFitMsgId(e+1):e},n.invokePC=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n,t,i){var r=this;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===t&&(t={}),void 0===i&&(i={msgId:1}),e.abrupt("return",new Promise((function(e,a){try{t=_extends({_apiName:n},t);var o=r.findFitMsgId(Date.now()),s=i.pcClientAPIName||n;if(i.msgId=o,!window.dingtalk)return Promise.reject(new Error("请在钉钉容器内使用 JSAPI"));r.apiList[n]?r.apiList[n].call(null,t,i):(console.info("invoke bridge api:",s,o,t),window.dingtalk.platform.invokeAPI(o,s,t)),window.dingtalk.callbackStack[""+o]=function(n){var t=n;return t.body?e(t.body):e(t)}}catch(e){a(e)}})));case 3:case"end":return e.stop()}}),e)})));return function(n,t,i){return e.apply(this,arguments)}}(),n.handleBridgeResponse=function(e,n,t){e&&e.errorCode?e.errorCode===BRIDGE_ERROR_CODE.SUCCESS?n(e.result):(console.warn("API 调用失败",e),t(e)):e&&"false"===e.success?t(e):n(e)},n.invoke=function(){var e=_asyncToGenerator(_regeneratorRuntime.mark((function e(n,t,i){var r;return _regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===t&&(t={}),(r=this.getAppType())!==API_INVOKER_TYPE.MOBILE){e.next=8;break}if(this.isReady){e.next=5;break}return e.abrupt("return",Promise.reject("错误：请在 dd.ready() 回调中使用 JSAPI，当前调用函数："+n));case 5:return e.abrupt("return",this.invokeMobile(n,t));case 8:if(r!==API_INVOKER_TYPE.PC){e.next=12;break}return e.abrupt("return",this.invokePC(n,t,i));case 12:if(r!==API_INVOKER_TYPE.MINI_APP){e.next=16;break}return e.abrupt("return",this.invokeMiniApp(n,t));case 16:return e.abrupt("return",Promise.reject("错误：未在钉钉运行环境下调用该 API，无效，请检查运行环境"));case 17:case"end":return e.stop()}}),e,this)})));return function(n,t,i){return e.apply(this,arguments)}}(),n.existEventListener=function(e){return!!this.continuousCallbackStack[e]},n.registerContinuesEvent=function(e,n){this.continuousCallbackStack[e]=n},n.removeContinuesEvent=function(e){this.existEventListener(e)&&(this.continuousCallbackStack[e](),delete this.continuousCallbackStack[e])},e}();export default new Invoker;